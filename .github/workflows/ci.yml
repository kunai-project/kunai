name: CI

on: 
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Install system tools
      run: |
        sudo apt update
        sudo apt install -y clang lld libbpf-dev

    # we need to fetch rust deps first to speed up cargo xtask
    - name: Cache Rust dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo
          ~/.rustup
          target
        key: ${{ runner.os }}-rust-${{ hashFiles('**/Cargo.lock', '**/.github/workflows/ci.yml') }}

    - name: Run clippy on full project
      run: cargo xtask clippy -- --workspace -- -D warnings

    - name: Install bpf-linker
      run: cargo install bpf-linker
      
    - name: Build (eBPF and userland)
      run: cargo xtask build --release

  tests:
    needs: build
    
    name: Testing on ${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - arch: amd64
            qemu-package: qemu-system-x86
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-latest
            qemu-package: qemu-system-arm

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      
    - name: Install system tools
      run: |
        sudo apt update
        sudo apt install -y ${{ matrix.qemu-package }}
        
    # we need to fetch rust deps first to speed up cargo xtask
    - name: Cache Rust dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo
          ~/.rustup
          target
        key: ${{ runner.os }}-rust-${{ hashFiles('**/Cargo.lock', '**/.github/workflows/ci.yml') }}
      
    - name: Set kernel cache key
      run: echo "KERNEL_CACHE_KEY=cache-vmlinuz-${{ matrix.arch }}-cache-$(date +%Y-%m-%d)" >> $GITHUB_ENV

    - name: Cache Linux Kernels
      uses: actions/cache@v4
      with:
        path: cache
        key: ${{ env.KERNEL_CACHE_KEY }}

    - name: Linux Kernel LTS 5.4
      run: ./scripts/ci/test_kernel.sh 5.4
      
    - name: Linux Kernel LTS 5.10
      run: ./scripts/ci/test_kernel.sh 5.10

    - name: Linux Kernel LTS 5.15
      run: ./scripts/ci/test_kernel.sh 5.15

    - name: Linux Kernel LTS 6.1
      run: ./scripts/ci/test_kernel.sh 6.1

    - name: Linux Kernel LTS 6.6
      run: ./scripts/ci/test_kernel.sh 6.6

